"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3988],{4137:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=r,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||i;return n?o.createElement(h,a(a({ref:t},p),{},{components:n})):o.createElement(h,a({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,a=new Array(i);a[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:r,a[1]=s;for(var c=2;c<i;c++)a[c]=n[c];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},2141:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=n(7462),r=(n(7294),n(4137));const i={sidebar_position:1,title:"2. Function Implementation"},a=void 0,s={unversionedId:"prodev-5/step-2",id:"prodev-5/step-2",title:"2. Function Implementation",description:"Working as part of the PrioritZ fusion team you will be configuring a custom connector for a new API you build using Azure Functions. The team has decided to move the logic when a user creates a new \u201cask\u201d to the Azure Function API. This will keep the Power App formula simple and allow more complex logic to be added in the future. In this lab you will create the function, use the Dataverse API, secure the API with Azure AD, configure a custom connector to use the API, and change the Power App to use the connector.",source:"@site/docs/prodev-5/step-2.md",sourceDirName:"prodev-5",slug:"/prodev-5/step-2",permalink:"/Low-Code/docs/prodev-5/step-2",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"2. Function Implementation"},sidebar:"tutorialSidebar",previous:{title:"1. Build Azure Function",permalink:"/Low-Code/docs/prodev-5/step-1"},next:{title:"3. Publish to Azure",permalink:"/Low-Code/docs/prodev-5/step-3"}},l={},c=[{value:"1.1 Implement Function",id:"11-implement-function",level:2}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("admonition",{title:"LAB SCENARIO",type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Working as part of the PrioritZ fusion team you will be configuring a custom connector for a new API you build using Azure Functions. The team has decided to move the logic when a user creates a new \u201cask\u201d to the Azure Function API. This will keep the Power App formula simple and allow more complex logic to be added in the future. In this lab you will create the function, use the Dataverse API, secure the API with Azure AD, configure a custom connector to use the API, and change the Power App to use the connector."),(0,r.kt)("p",{parentName:"admonition"},"Note: This lab requires an Azure subscription (or trial) in the ",(0,r.kt)("strong",{parentName:"p"},"same tenant")," as your Dataverse environment."),(0,r.kt)("p",{parentName:"admonition"},"In ",(0,r.kt)("strong",{parentName:"p"},"Exercise 2")," you will implement the function.")),(0,r.kt)("h2",{id:"11-implement-function"},"1.1 Implement Function"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click New file.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Name the new file ",(0,r.kt)("inlineCode",{parentName:"p"},"Model.cs"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open the new ",(0,r.kt)("inlineCode",{parentName:"p"},"Model.cs")," file and paste the code below. This will define the data that will be sent from the Power App."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'using System;\nusing Microsoft.Azure.WebJobs.Extensions.OpenApi.Core.Attributes;\nusing Microsoft.OpenApi.Models;\nnamespace Contoso.PrioritZ\n{\n public class TopicItemModel\n  {\n    public string Choice { get; set; }\n    public string Photo { get; set; }\n  }\n  public class TopicModel\n  {\n    [OpenApiProperty(Nullable = false, Description = "This is a topic")]\n    public string Topic { get; set; }\n    public string Details { get; set; }\n    public DateTime RespondBy { get; set; }\n    public string MyNotes { get; set; }\n    public string Photo { get; set; }\n    public TopicItemModel[] Choices {get;set;}\n  }\n}\n')),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open the CreateTopic file.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Locate the Run method attributes and replace them with the attributes below. This provides user friendly names when we create a connector to use the API."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'[FunctionName("CreateTopic")]\n[OpenApiOperation(operationId: "CreateTopic", tags: new[] { "name" }, Summary = "Create Topic", Description = "Create Topic", Visibility = OpenApiVisibilityType.Important)]\n[OpenApiSecurity("function_key", SecuritySchemeType.ApiKey, Name = "code", In = OpenApiSecurityLocationType.Query)]\n[OpenApiResponseWithBody(statusCode: HttpStatusCode.OK, contentType: "application/json", bodyType: typeof(Guid), Description = "The Guid response")]\n[OpenApiRequestBody(contentType: "application/json", bodyType: typeof(TopicModel))]\n')),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Remove get from the Run method. You should only have post.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Go to the Terminal and add Power Platform Dataverse Client package."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"dotnet add package Microsoft.PowerPlatform.Dataverse.Client\n")),(0,r.kt)("ol",{start:8},(0,r.kt)("li",{parentName:"ol"},"Wait for the package to be added."),(0,r.kt)("li",{parentName:"ol"},"Add Azure Identity package.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"dotnet add package Azure.Identity\n")),(0,r.kt)("ol",{start:10},(0,r.kt)("li",{parentName:"ol"},"Wait for the package to be added."),(0,r.kt)("li",{parentName:"ol"},"Open the CreateTopic file and add the using statements below.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},"using System;\nusing Microsoft.Identity.Client;\nusing Azure.Core;\nusing Azure.Identity;\nusing Microsoft.PowerPlatform.Dataverse.Client;\nusing Microsoft.Azure.WebJobs.Extensions.OpenApi.Core.Enums;\nusing Microsoft.Xrm.Sdk; \n")),(0,r.kt)("ol",{start:12},(0,r.kt)("li",{parentName:"ol"},"Add the below method after the run method. This method will use the token passed from the calling app to get a new token that will allow the function to use the Dataverse API on behalf of the calling user.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},' public static async Task<string> GetAccessTokenAsync(HttpRequest req, string resourceUri)\n        {\n            //Get the calling user token from the request to use as UserAssertion\n            var headers = req.Headers;\n            var token = string.Empty;\n            if (headers.TryGetValue("Authorization", out var authHeader))\n            {\n                if (authHeader[0].StartsWith("Bearer "))\n                {\n                    token = authHeader[0].Substring(7, authHeader[0].Length - 7);\n                }\n            }\n\n            string[] scopes = new[] { $"{resourceUri}/.default" };\n            string clientSecret = Environment.GetEnvironmentVariable("ClientSecret");\n            string clientId = Environment.GetEnvironmentVariable("ClientID");\n            string tenantId = Environment.GetEnvironmentVariable("TenantID");\n\n            var app = ConfidentialClientApplicationBuilder.Create(clientId)\n              .WithClientSecret(clientSecret).WithAuthority($"https://login.microsoftonline.com/{tenantId}")\n              .Build();\n            //Get On Behalf Of Token for calling user\n            UserAssertion userAssertion = new UserAssertion(token);\n            var result = await app.AcquireTokenOnBehalfOf(scopes, userAssertion).ExecuteAsync();\n\n            return result.AccessToken;\n        }\n')),(0,r.kt)("ol",{start:13},(0,r.kt)("li",{parentName:"ol"},"Replace the code inside the Run method with code below. This will get an instance of the Dataverse API and use the GetAccessToken function we just defined.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},'_logger.LogInformation("Starting Create Topic");\n\n            var serviceClient = new ServiceClient(\n                  instanceUrl: new Uri(Environment.GetEnvironmentVariable("DataverseUrl")),\n                  tokenProviderFunction: async uri => { return await GetAccessTokenAsync(req, Environment.GetEnvironmentVariable("DataverseUrl")); },\n                  useUniqueInstance: true,\n                  logger: _logger);\n\n            if (!serviceClient.IsReady)\n            {\n                throw new Exception("Authentication Failed!");\n            }\n')),(0,r.kt)("ol",{start:14},(0,r.kt)("li",{parentName:"ol"},"Add the following code after the if statement of the Run method to reserialize the request. This will get us the data passed from the caller.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},"string requestBody = await new StreamReader(req.Body).ReadToEndAsync();\nvar data = JsonConvert.DeserializeObject<TopicModel>(requestBody);\n")),(0,r.kt)("ol",{start:15},(0,r.kt)("li",{parentName:"ol"},"Add the code below that will create the row to the Run method. This code creates the rows in Dataverse and is where we might add more logic in the future.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},'var ask = new Entity("contoso_prioritztopic");\n            ask["contoso_topic"] = data.Topic;\n            ask["contoso_details"] = data.Details;\n            ask["contoso_mynotes"] = data.MyNotes;\n            ask["contoso_respondby"] = data.RespondBy.Date;\n            if (data.Photo != null)\n            {\n                // Remove unnecessary double quotes,\n                // Remove everything before the first comma (embedded stuff)\n                ask["contoso_photo"] = Convert.FromBase64String(data.Photo.Trim(\'\\"\').Split(\',\')[1]);\n            }\n            var topicId = await serviceClient.CreateAsync(ask);\n\n            foreach (var choice in data.Choices)\n            {\n                var item = new Entity("contoso_prioritztopicitem");\n                item["contoso_choice"] = choice.Choice;\n                item["contoso_prioritztopic"] = new EntityReference("contoso_prioritztopic", topicId);\n                if (choice.Photo != null)\n                {\n                    item["contoso_photo"] = Convert.FromBase64String(choice.Photo.Trim(\'\\"\').Split(\',\')[1]);\n                }\n\n                var choiceId = await serviceClient.CreateAsync(item);\n            }\n')),(0,r.kt)("ol",{start:16},(0,r.kt)("li",{parentName:"ol"},"Return the topic id as JSON (required by Power Apps). Add the code below to the Run method.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cs"},"return new OkObjectResult(topicId);\n")))}u.isMDXComponent=!0}}]);